## "å‰å°"å‡ ç§å¤„ç†è·¨åŸŸæ–¹å¼æ€»ç»“

###  Â§ WHY ä¼šå‡ºç°è·¨åŸŸé—®é¢˜ï¼Œè·¨åŸŸæ˜¯ä»€ä¹ˆï¼Ÿ
<pre><p>  æµè§ˆå™¨ä¸èƒ½æ‰§è¡Œå…¶ä»–ç½‘ç«™çš„è„šæœ¬ã€‚å®ƒæ˜¯ç”±æµè§ˆå™¨çš„åŒæºç­–ç•¥é€ æˆçš„ï¼Œæ˜¯æµè§ˆå™¨å¯¹javascriptæ–½åŠ çš„å®‰å…¨é™åˆ¶ï¼Œä¸å…è®¸è·¨åŸŸè°ƒç”¨å…¶ä»–é¡µé¢çš„å¯¹è±¡ã€‚ä½†åœ¨å®‰å…¨é™åˆ¶çš„åŒæ—¶ä¹Ÿç»™æ³¨å…¥iframeæˆ–æ˜¯ajaxåº”ç”¨ä¸Šå¸¦æ¥äº†ä¸å°‘éº»çƒ¦ã€‚è¿™é‡ŒæŠŠæ¶‰åŠåˆ°è·¨åŸŸçš„ä¸€äº›é—®é¢˜ç®€å•åœ°æ•´ç†ä¸€ä¸‹ï¼š</p></pre>

> ç®€è¨€ä¹‹ï¼Œç”±äºåŒæºç­–ç•¥çš„é™åˆ¶ï¼ŒXmlHttpRequeståªå…è®¸è¯·æ±‚å½“å‰æºï¼ˆåŸŸåã€åè®®ã€ç«¯å£ï¼‰çš„èµ„æºï¼Œå¦‚a.comåŸŸåä¸‹çš„jsæ— æ³•æ“ä½œb.comæˆ–æ˜¯c.a.comåŸŸåä¸‹çš„å¯¹è±¡ã€‚å…·ä½“è¡¨æ ¼:


|   URL          |   è¯´æ˜      |          æ˜¯å¦å…è®¸é€šä¿¡              |
|   :---        |       :---:     |            :---  |
|   http://www.a.com/a.js <br/>http://www.a.com/b.js                | åŒä¸€åŸŸåä¸‹  						   	|  å…è®¸      |
|   http://www.a.com/lab/a.js <br/>http://www.a.com/script/b.js     | åŒä¸€åŸŸåä¸‹ä¸åŒæ–‡ä»¶å¤¹        	|  å…è®¸      |
|   http://www.a.com:8000/a.js<br/>http://www.a.com/b.js     				| åŒä¸€åŸŸåï¼Œä¸åŒç«¯å£          	|  ä¸å…è®¸    |
|   http://www.a.com/a.js<br/>http://70.32.92.74/b.js               | åŸŸåå’ŒåŸŸåå¯¹åº”ip            |  ä¸å…è®¸    |
|  	http://www.a.com/a.js<br/>http://script.a.com/b.js              | ä¸»åŸŸç›¸åŒï¼Œå­åŸŸä¸åŒ	          |  ä¸å…è®¸    |
|   http://www.a.com/a.js<br/>http://a.com/b.js                     | åŒä¸€åŸŸåï¼Œä¸åŒäºŒçº§åŸŸå       	|  ä¸å…è®¸    |
|   http://www.a.com/a.js<br/>https://a.com/a.js                    | åŒä¸€åŸŸåï¼Œä¸åŒåè®®          	|  ä¸å…è®¸    |
|   http://www.cnblogs.com/a.js<br/>http://www.a.com/b.js           | ä¸åŒåŸŸå                		|  ä¸å…è®¸    |

> PS è·¨åŸŸç‰¹åˆ«æ³¨æ„ä¸¤ç‚¹ï¼š

* ç¬¬ä¸€ï¼Œå¦‚æœæ˜¯åè®®å’Œç«¯å£é€ æˆçš„è·¨åŸŸé—®é¢˜â€œå‰å°â€æ˜¯æ— èƒ½ä¸ºåŠ›çš„ï¼Œ
* ç¬¬äºŒï¼Œåœ¨è·¨åŸŸé—®é¢˜ä¸Šï¼ŒåŸŸä»…ä»…æ˜¯é€šè¿‡â€œURLçš„é¦–éƒ¨â€æ¥è¯†åˆ«è€Œä¸ä¼šå»å°è¯•åˆ¤æ–­ç›¸åŒçš„ipåœ°å€å¯¹åº”ç€ä¸¤ä¸ªåŸŸæˆ–ä¸¤ä¸ªåŸŸæ˜¯å¦åœ¨åŒä¸€ä¸ªipä¸Šã€‚

> URLçš„é¦–éƒ¨: `window.location.protocol + window.location.host` <=> `Domain, protocols and ports must match`;

### Â§ã€document.domain+iframeçš„è®¾ç½®

> ä½¿ç”¨åœºæ™¯ 

---- `ä¸»åŸŸç›¸åŒï¼Œå­åŸŸä¸åŒ`(å³ä»…é€‚ç”¨äºä¸»åŸŸç›¸åŒè€ŒäºŒçº§åŸŸåä¸åŒ)

> ä½¿ç”¨æ­¥éª¤ 

* è®¾ç½®document.domain å¦‚urlåˆ†åˆ« `http://mcbeta.jd.com/demo/index.html` å’Œ `http://beta-mcdata.jd.com/demo/iframeIndex.html` ä¸ºurlçš„ä¸»åŸŸå`jd.com`;

* åœ¨index.htmlæ–‡ä»¶ä¸­æ·»åŠ iframeï¼Œé€šè¿‡æ§åˆ¶iframeçš„contentDocumentï¼Œå®ç°ä¸¤ä¸ªjsæ–‡ä»¶ä¹‹é—´çš„`äº¤äº’`;

* [ğŸŒ° document.domain DEMO](http://mcbeta.jd.com/demo/index.html)

> ps:æŸä¸€é¡µé¢çš„domainé»˜è®¤ç­‰äºwindow.location.hostnameã€‚ä¸»åŸŸåæ˜¯ä¸å¸¦mcbetaçš„åŸŸåï¼Œä¾‹å¦‚jd.comï¼Œ
ä¸»åŸŸåå‰é¢å¸¦å‰ç¼€çš„é€šå¸¸éƒ½ä¸ºäºŒçº§åŸŸåæˆ–å¤šçº§åŸŸåï¼Œä¾‹å¦‚ mcbeta.jd.comå…¶å®æ˜¯äºŒçº§åŸŸåã€‚ domainåªèƒ½è®¾ç½®ä¸ºä¸»åŸŸåï¼Œä¸å¯ä»¥åœ¨mcbeta.jd.comä¸­å°†domainè®¾ç½®ä¸ºbeta-mcdata.jd.comã€‚


> ç¼ºç‚¹

* å®‰å…¨æ€§ï¼Œå½“ä¸€ä¸ªç«™ç‚¹ï¼ˆb.a.comï¼‰è¢«æ”»å‡»åï¼Œå¦ä¸€ä¸ªç«™ç‚¹ï¼ˆc.a.comï¼‰ä¼šå¼•èµ·å®‰å…¨æ¼æ´ã€‚
* å¦‚æœä¸€ä¸ªé¡µé¢ä¸­å¼•å…¥å¤šä¸ªiframeï¼Œè¦æƒ³èƒ½å¤Ÿæ“ä½œæ‰€æœ‰iframeï¼Œå¿…é¡»éƒ½å¾—è®¾ç½®ç›¸åŒdomainã€‚

### Â§ã€window.name+iframeçš„è®¾ç½®
> å†å²

* window.name ä¼ è¾“æŠ€æœ¯ï¼ŒåŸæœ¬æ˜¯ Thomas Frank ç”¨äºè§£å†³ cookie çš„ä¸€äº›åŠ£åŠ¿ï¼ˆæ¯ä¸ªåŸŸå 4 x 20 Kb çš„é™åˆ¶ã€æ•°æ®åªèƒ½æ˜¯å­—ç¬¦ä¸²ã€è®¾ç½®å’Œè·å– cookie è¯­æ³•çš„å¤æ‚ç­‰ç­‰ï¼‰è€Œå‘æ˜çš„ï¼ˆè¯¦ç»†è§åŸæ–‡ï¼šã€ŠSession variables without cookiesã€‹ï¼‰ï¼Œåæ¥ Kris Zyp åœ¨æ­¤æ–¹æ³•çš„åŸºç¡€ä¸Šå¼ºåŒ–äº† window.name ä¼ è¾“ ï¼Œå¹¶å¼•å…¥åˆ°äº† Dojo ï¼ˆdojox.io.windowNameï¼‰ï¼Œç”¨æ¥è§£å†³è·¨åŸŸæ•°æ®ä¼ è¾“é—®é¢˜

> ä½¿ç”¨åœºæ™¯

---- å®Œå…¨è·¨åŸŸ

> ä½¿ç”¨æ­¥éª¤

* æœ‰ä¸‰ä¸ªé¡µé¢ 
	* mcbeta.jd.com/app.html       åº”ç”¨é¡µé¢
	* mcbeta.jd.com/proxy.html     ä»£ç†æ–‡ä»¶ï¼ˆç©ºç™½é¡µé¢ï¼‰
	* beta-mcdata.jd.com/index.php åº”ç”¨é¡µé¢éœ€è¦è·å–æ•°æ®çš„é¡µé¢ï¼Œå¯ç§°ä¸ºæ•°æ®é¡µé¢
* [ğŸŒ° window.name DEMO](http://mcbeta.jd.com/demo/app.html)

> ä¼˜ç‚¹ï¼š

* name å€¼åœ¨ä¸åŒçš„é¡µé¢ï¼ˆç”šè‡³ä¸åŒåŸŸåï¼‰åŠ è½½åä¾æ—§å­˜åœ¨ï¼Œå¹¶ä¸”å¯ä»¥æ”¯æŒéå¸¸é•¿çš„ name å€¼ï¼ˆ2MBï¼‰
* æ“ä½œå®‰å…¨ã€ä¼ è¾“å¿«

> æ€»ç»“

* iframeçš„srcå±æ€§ç”±å¤–åŸŸè½¬å‘æœ¬åœ°åŸŸï¼Œè·¨åŸŸæ•°æ®å³ç”±iframeçš„window.nameä»å¤–åŸŸä¼ é€’åˆ°æœ¬åœ°åŸŸã€‚è¿™ä¸ªå°±å·§å¦™åœ°ç»•è¿‡äº†æµè§ˆå™¨çš„è·¨åŸŸè®¿é—®é™åˆ¶ï¼Œä½†åŒæ—¶å®ƒåˆæ˜¯å®‰å…¨æ“ä½œ
* iframeæ ‡ç­¾çš„è·¨åŸŸèƒ½åŠ›

* window.nameå±æ€§å€¼åœ¨æ–‡æ¡£åˆ·æ–°åä¾æ—§å­˜åœ¨çš„èƒ½åŠ›


### Â§ã€åˆ©ç”¨iframeå’Œlocation.hash

> ä½¿ç”¨åœºæ™¯

---- å®Œå…¨è·¨åŸŸ

> ä½¿ç”¨æ­¥éª¤åŠåŸç†

* åŸç†ï¼Œ åˆ©ç”¨location.hashä¼ å€¼;åœ¨url:`http://mcbeta.jd.com/hash.html#code` ä¸­çš„â€˜#codeâ€™ å°±æ˜¯ location.hash ï¼Œ æ”¹å˜ hash å¹¶ä¸ä¼š å¯¼è‡´é¡µé¢åˆ·æ–°ï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨hashå€¼æ¥è¿›è¡Œæ•°æ®ä¼ é€’ï¼Œå½“ç„¶æ•°æ®å®¹é‡æ˜¯æœ‰é™çš„;

* ä»¥`http://mcbeta.jd.com/hash.html` å’Œ`http://beta-mcdata.jd.com/iframeHash.html` ä¹‹é—´çš„æ•°æ®é€šä¿¡ä¸ºä¾‹

	* hash.html é¦–å…ˆåˆ›å»ºè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªéšè—çš„iframeï¼Œiframeçš„srcæŒ‡å‘beta-mcdata.jd.comåŸŸåä¸‹çš„ iframeHash.htmlé¡µé¢ï¼Œè¿™æ—¶çš„hashå€¼å¯ä»¥åšå‚æ•°ä¼ é€’ç”¨;
	
	* iframeHash.htmlå“åº”è¯·æ±‚åå†å°†é€šè¿‡ä¿®æ”¹hash.htmlçš„hashå€¼æ¥ä¼ é€’æ•°æ®ï¼ˆç”±äºä¸¤ä¸ªé¡µé¢ä¸åœ¨åŒä¸€ä¸ªåŸŸä¸‹,IEã€Chromeä¸å…è®¸ä¿®æ”¹parent.location.hashçš„å€¼ï¼Œæ‰€ä»¥è¦å€ŸåŠ©äºmcbeta.jd.comåŸŸåä¸‹çš„ä¸€ä¸ªä»£ç†iframeï¼›Firefoxå¯ä»¥ä¿®æ”¹ï¼‰

	* ä¸æ­¤åŒæ—¶ï¼Œhash.htmlä¸ŠåŠ ä¸€ä¸ªå®šæ—¶å™¨ï¼Œéš”ä¸€æ®µæ—¶é—´æ¥åˆ¤æ–­location.hashçš„å€¼æœ‰æ²¡æœ‰å˜åŒ–ï¼Œä¸€ç‚¹æœ‰å˜åŒ–åˆ™è·å–è·å–hashå€¼;

* [ğŸŒ° location Hash DEMO](http://mcbeta.jd.com/hash.html)

> ç¼ºç‚¹

* æ•°æ®å®¹é‡ã€ç±»å‹æœ‰é™ã€æ•°æ®æš´éœ²åœ¨urlä¸Š

### Â§ã€åŠ¨æ€åˆ›å»ºscript

> ä½¿ç”¨åœºæ™¯

---- å®Œå…¨è·¨åŸŸ

> åŸç†

* è™½ç„¶æµè§ˆå™¨é»˜è®¤ç¦æ­¢äº†è·¨åŸŸè®¿é—®ï¼Œä½†å¹¶ä¸ç¦æ­¢åœ¨é¡µé¢ä¸­å¼•ç”¨å…¶ä»–åŸŸçš„JSæ–‡ä»¶ï¼Œå¹¶å¯ä»¥è‡ªç”±æ‰§è¡Œå¼•å…¥çš„JSæ–‡ä»¶ä¸­çš„functionï¼ˆåŒ…æ‹¬æ“ä½œcookieã€Domç­‰ç­‰ï¼‰ã€‚æ ¹æ®è¿™ä¸€ç‚¹ï¼Œå¯ä»¥æ–¹ä¾¿åœ°é€šè¿‡åˆ›å»ºscriptèŠ‚ç‚¹çš„æ–¹æ³•æ¥å®ç°å®Œå…¨è·¨åŸŸçš„é€šä¿¡ï¼›

> å…¸å‹åº”ç”¨ JSONP

* ç®€è¿°
	* é€šè¿‡scriptæ ‡ç­¾å®ç°è·¨åŸŸè¯·æ±‚ï¼Œç„¶ååœ¨æœåŠ¡ç«¯è¾“å‡ºJSONæ•°æ®å¹¶æ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œä»è€Œè§£å†³äº†è·¨åŸŸçš„æ•°æ®è¯·æ±‚

	* jsonpçš„å®ç°æ ¸å¿ƒå°±æ˜¯åˆ©ç”¨scriptæ ‡ç­¾çš„è·¨åŸŸèƒ½åŠ›ï¼Œè€Œä¸xhræˆ–è€…è¯´ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„ajaxå¹¶æ²¡æœ‰å…³ç³»;

	* jsonpæä¾›çš„urlï¼ˆå³åŠ¨æ€ç”Ÿæˆçš„scriptæ ‡ç­¾çš„srcï¼‰ï¼Œæ— è®ºçœ‹ä¸Šå»æ˜¯ä»€ä¹ˆå½¢å¼ï¼Œæœ€ç»ˆç”Ÿæˆè¿”å›çš„éƒ½æ˜¯ä¸€æ®µjsä»£ç 

	* jsonpåªæ”¯æŒGETè¯·æ±‚ï¼Œä¸æ”¯æŒPOSTè¯·æ±‚


### Â§ã€ä½¿ç”¨HTML5 postMessage

> ä½¿ç”¨èƒŒæ™¯

* HTML5ä¸­æœ€é…·çš„æ–°åŠŸèƒ½ä¹‹ä¸€å°±æ˜¯ è·¨æ–‡æ¡£æ¶ˆæ¯ä¼ è¾“Cross Document Messagingã€‚ä¸‹ä¸€ä»£æµè§ˆå™¨éƒ½å°†æ”¯æŒè¿™ä¸ªåŠŸèƒ½ï¼šChrome 2.0+ã€Internet Explorer 8.0+, Firefox 3.0+, Opera 9.6+, å’Œ Safari 4.0+ ã€‚ Facebookå·²ç»ä½¿ç”¨äº†è¿™ä¸ªåŠŸèƒ½ï¼Œç”¨postMessageæ”¯æŒåŸºäºwebçš„å®æ—¶æ¶ˆæ¯ä¼ é€’ã€‚

####  otherWindow.postMessage(message, targetOrigin);

* otherWindow: å¯¹æ¥æ”¶ä¿¡æ¯é¡µé¢çš„ windowçš„å¼•ç”¨ã€‚å¯ä»¥æ˜¯é¡µé¢ä¸­iframeçš„contentWindowå±æ€§ï¼› window.opençš„è¿”å›å€¼ï¼›é€šè¿‡nameæˆ–ä¸‹æ ‡ä» window.frames å–åˆ°çš„å€¼ã€‚

* message: æ‰€è¦å‘é€çš„æ•°æ®ï¼Œstringç±»å‹ã€‚
* targetOrigin: ç”¨äºé™åˆ¶otherWindowï¼Œâ€œ*â€è¡¨ç¤ºä¸ä½œé™åˆ¶

> ğŸŒ°

```javascript
	<script>
	var windowObj = window; // å¯ä»¥æ˜¯å…¶ä»–çš„ Window å¯¹è±¡çš„å¼•ç”¨
	var data = null;

	addEventListener('message', function(e){
	    if(e.origin == 'http://jasonkid.github.io/fezone') {
	        data = e.data;
	        
	        e.source.postMessage('Got it!', '*');
	    }
	});
	</script>
```

> æ€»ç»“
* message äº‹ä»¶å°±æ˜¯ç”¨æ¥æ¥æ”¶ postMessage å‘é€è¿‡æ¥çš„è¯·æ±‚çš„ã€‚å‡½æ•°å‚æ•°çš„å±æ€§æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š

	* origin: å‘é€æ¶ˆæ¯çš„ window çš„æºã€‚

	* data: æ•°æ®ã€‚

	* source: å‘é€æ¶ˆæ¯çš„ Window å¯¹è±¡ã€‚


